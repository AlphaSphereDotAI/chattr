name: Lint
on:
  workflow_call:
permissions:
  contents: write
  pull-requests: write
  checks: write
  security-events: write
  actions: read
jobs:
  trufflehog:
    name: TruffleHog
    runs-on: ubuntu-latest
    environment:
      name: code_quality
    steps:
      - name: Git Secret Scanning
        uses: addnab/docker-run-action@v3
        with:
          image: trufflesecurity/trufflehog:latest
          options: --rm
          shell: bash
          run: >
            trufflehog git ${{github.event.repository.html_url}} --branch=${{github.head_ref || github.ref_name}}
            --fail --github-actions --results=verified,unknown --log-level=4 --no-update
  pre-commit:
    name: pre-commit
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - uses: actions/checkout@v5
      - name: Install uv
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e  # v6
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
          activate-environment: true
      - name: Install the project
        run: uv sync --frozen --only-dev
      - uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: pre-commit-
      - run: pre-commit run --show-diff-on-failure --color=always --all-files
        continue-on-error: true
      - uses: pre-commit-ci/lite-action@v1.1.0
  ls_lint:
    name: ls-lint
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - uses: actions/checkout@v4
      - uses: ls-lint/action@v2
        with:
          config: .github/lint/.ls-lint.yaml
  ruff_format:
    name: Ruff Format
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      - name: Format
        uses: astral-sh/ruff-action@v3.5.1
        with:
          args: format . --config .github/lint/.ruff.toml
      - name: Commit and push applied linter fixes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: '[Ruff] Apply linters fixes'
          commit_options: --no-verify
  yamlfix:
    name: YamlFix
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      - name: Install uv
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e  # v6
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
          activate-environment: true
      - name: Install the project
        run: uv sync --frozen --only-dev
      - name: Format
        run: yamlfix --config-file .github/lint/.yamlfix.toml .
      - name: Commit and push applied linter fixes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: '[YamlFix] Apply linters fixes'
          commit_options: --no-verify
  syft:
    name: Syft
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: SBOM Generation
        uses: anchore/sbom-action@v0.20.10
        with:
          path: .
          dependency-snapshot: true
          output-file: ${{ github.event.repository.name }}-sbom.json
          format: syft-json
  grype:
    name: Grype
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Install uv
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e  # v6
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
          activate-environment: true
      - name: Export requirements to requirements.txt
        run: >
          uv export --quiet --no-hashes --format requirements.txt --output-file requirements.txt
      - name: Scan current project
        uses: anchore/scan-action@v7.2.1
        id: scan
        with:
          path: .
          cache-db: true
      - name: upload Anchore scan SARIF report
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
  trivy:
    name: Trivy
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5
      - name: Run Trivy vulnerability scanner in repo mode
        uses: aquasecurity/trivy-action@0.33.1
        with:
          scan-type: repo
          format: sarif
          output: trivy-results.sarif
          github-pat: ${{ secrets.GH_TOKEN }}
          exit-code: '1'
          list-all-pkgs: true
      - name: Upload Trivy scan results to GitHub Security tab
        if: success() || failure()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: trivy-results.sarif
  bandit:
    name: Bandit
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - uses: actions/checkout@v4
      - name: Bandit Scan
        uses: shundor/python-bandit-scan@v1.0
        with:
          exit_zero: true
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  dclint:
    name: DCLint
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - uses: actions/checkout@v4
      - uses: docker-compose-linter/dclint-github-action@v1.6.0
        with:
          fix: true
          recursive: true
  ty:
    name: Ty
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Checkout repository
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8  # v5
        with:
          token: ${{ secrets.GH_TOKEN }}
      - name: Install uv
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e  # v6
        with:
          enable-cache: true
          cache-dependency-glob: uv.lock
          activate-environment: true
      - name: Install the project
        run: uv sync --frozen
      - name: Check
        run: ty check --output-format github
  ruff:
    name: Ruff
    runs-on: ubuntu-latest
    needs: trufflehog
    environment:
      name: code_quality
    steps:
      - name: Check out repository
        uses: actions/checkout@v4
      - name: Check
        uses: astral-sh/ruff-action@v3.5.1
        with:
          args: check --output-format github --config .github/lint/.ruff.toml
